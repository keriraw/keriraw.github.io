<html>
	<head>
		<title>Missile</title>
	</head>
	<body style="background-color: #101010">
		<div>
			<a href="./index.html">Back</a>
		</div>
		<div>
			<canvas id="missilePlayground" width="800" height="600" style="border:1px solid #FF0000; margin: auto; position: absolute; left: 0; right: 0; z-index: 1;"></canvas>
			<canvas id="missileBackground" width="800" height="600" style="border:1px solid #FF0000; margin: auto; position: absolute; left: 0; right: 0; z-index: 0; background-color: #000000;"></canvas>
		</div>
	</body>

	<script>
		// Gets the canvas context
		var b = document.getElementById("missileBackground");
		var back = b.getContext("2d");

		var p = document.getElementById("missilePlayground");
		var play = p.getContext("2d");

		var params = {
			gameSpeed: 2,
			baseHeight: 50,
			baseCount: 5,
			towerBaseHeight: 5,
			maxEnemies: 10,
			trail: false,
			trailLength: 3
		};

		var game = {
			status: 'loading',
			score: 0
		};

		var towers = [];

		var missiles = [];

		var enemies = [];

		var colors = {
			background: '#000000',
			terrain: '#660D0D',
			tower: '#474747',
			enemy: '#FF0000',
			missile: '#00FF00'
		}

		// Creates the terrain
		function terrainCreate(){
			terrainBase();
			terrainTower(params.baseCount);
		};

		// Creates the lower part of the terrain
		function terrainBase(){
			back.fillStyle = colors.terrain;
			back.fillRect(0,b.height-params.baseHeight,b.width,params.baseHeight);
		};

		// Calculates where the mounds are located
		function terrainTower(amount){
			for (var i = 1; i < amount+1; i++){
				var location = Math.floor((b.width/(amount+1))*i);
				terrainMound(location);
				towerCreate(location);
			}
		};

		// Creates a single mound
		function terrainMound(xMiddleCoord){
			back.fillStyle = colors.terrain;
			xMiddleCoord = xMiddleCoord-50;
			var heightCoord = b.height-params.baseHeight;
			back.beginPath();
			back.moveTo(xMiddleCoord,heightCoord); //100,100 | 0,0
			back.lineTo(xMiddleCoord+100,heightCoord); //200,100 | 100,0
			back.lineTo(xMiddleCoord+70,heightCoord-20); //170,80 | 70,-20
			back.lineTo(xMiddleCoord+30,heightCoord-20); //130,80 | 30,-20
			back.fill();
		};

		// Creates a single tower
		function towerCreate(xMiddleCoord){
			back.fillStyle = colors.tower;
			// Calculates the height in the middle of the tower, canvas heigh - (terrain base + mound height + flat tower part)
			var heightCoord = b.height-(params.baseHeight+20+params.towerBaseHeight);
			back.beginPath();
			// Creates the upper part of the tower (the half circle)
			back.arc(xMiddleCoord,heightCoord,15,0,1*Math.PI,true);
			back.fillRect(xMiddleCoord-15,heightCoord,30,params.towerBaseHeight)
			back.fill();

			towers.push({
				name: 'tower' + towers.length,
				status: 'alive',
				center: xMiddleCoord,
				charge: 100
			});
		};

		function rechargeTowers(){
			towers.forEach(function(tower){
				console.log(tower);
				if (tower.charge < 100){
					// TODO: adjust recharge rate
					tower.charge += 1 * params.gameSpeed;
				}
			});
		};

		function enemySpawn(){
			// TODO: make acceptance vary dependign on enemies
			if (enemies.length < params.maxEnemies && acceptancePercent(5)){
				var xCoord = Math.floor(Math.random() * 800),
					yCoord = Math.floor(Math.random() * -200),
					xDest = Math.floor(Math.random() * 800),
					yDest = 600,
					xDelta = Math.abs(xDest - xCoord),
					yDelta = Math.abs(yDest - yCoord),
					travelLength = Math.sqrt((xDelta*xDelta)+(yDelta*yDelta));
				enemies.push({
					name: 'enemy' + enemies.length,
					xCoord: xCoord,
					yCoord: yCoord,
					xOrigin: xCoord,
					yOrigin: yCoord,
					xDest: xDest,
					yDest: yDest,
					xDelta: xDelta,
					yDelta: yDelta,
					xSpeed: (xDelta/travelLength)*params.gameSpeed,
					ySpeed: (yDelta/travelLength)*params.gameSpeed,
					travelLength: travelLength,
					status: 'alive'
				});
			}
		};

		function enemyMove(){
			enemies.forEach(function(enemy, index){
				// Calculate new position
				if (enemy.xOrigin < enemy.xDest){
					enemy.xCoord += enemy.xSpeed;
				} else {
					enemy.xCoord -= enemy.xSpeed;
				}
				enemy.yCoord += enemy.ySpeed;
				// TODO: Check empty location
				// Remove from enemies
				if (enemy.yCoord > 600 || enemy.status === 'dead'){
					enemies.splice(index, 1)
				} else {
					// Paint new position
					play.fillStyle = colors.enemy;
					play.fillRect(enemy.xCoord,enemy.yCoord,2,2);
				}
			});
		};

		// TODO:
		function explosion(center){

		};

		function findShootingTower(){
			var shootingTower = towers.find(function (tower){
				return tower.status === 'alive' && tower.charge >= 100;
			})
			,	shootingTowerIndex = towers.findIndex(function (tower){
				return tower.status === 'alive' && tower.charge >= 100;
			});
			if(shootingTowerIndex >= 0){
				towers[shootingTowerIndex].charge = 0;
				return shootingTower.center;
			}
		};

		function spawnMissile(e){
			// TODO: if no tower available don't spawn
			var rect = p.getBoundingClientRect(),
				xDest = Math.floor(e.clientX - rect.left),
				yDest = Math.floor(e.clientY - rect.top),
				xCoord = findShootingTower(),
				yCoord = b.height-(params.baseHeight+20+params.towerBaseHeight+15);
				xDelta = Math.abs(xDest - xCoord),
				yDelta = Math.abs(yDest - yCoord),
				travelLength = Math.sqrt((xDelta*xDelta)+(yDelta*yDelta));
			// TODO: improve the comprobation
			// if xCoord is undefined, it's because there is not available tower
			if (xCoord){
				missiles.push({
					name: 'missile' + missiles.length,
					xCoord: xCoord,
					yCoord: yCoord,
					xOrigin: xCoord,
					yOrigin: yCoord,
					xDest: xDest,
					yDest: yDest,
					xDelta: xDelta,
					yDelta: yDelta,
					xSpeed: (xDelta/travelLength)*params.gameSpeed,
					ySpeed: (yDelta/travelLength)*params.gameSpeed,
					travelLength: travelLength,
					status: 'alive'
				});
			}
		};

		function missileMove(){
			missiles.forEach(function(missile, index){
				// Calculate new position
				if (missile.xOrigin < missile.xDest){
					missile.xCoord += missile.xSpeed;
				} else {
					missile.xCoord -= missile.xSpeed;
				}
				if (missile.yOrigin < missile.yDest){
					missile.yCoord += missile.ySpeed;
				} else {
					missile.yCoord -= missile.ySpeed;
				}
				// TODO: Check empty location
				// Remove from missiles
				if (calculateProximity(missile) || missile.status === 'dead'){
					missiles.splice(index, 1)
				} else {
					// Paint new position
					play.fillStyle = colors.missile;
					play.fillRect(missile.xCoord,missile.yCoord,2,2);
				}
			});
		};

		function calculateProximity(object){
			if (object.xOrigin < object.xDest && object.yOrigin < object.yDest){
				return object.xCoord > object.xDest && object.yCoord > object.yDest;
			} else if (object.xOrigin > object.xDest && object.yOrigin > object.yDest){
				return object.xCoord < object.xDest && object.yCoord < object.yDest;
			} else if (object.xOrigin < object.xDest && object.yOrigin > object.yDest){
				return object.xCoord > object.xDest && object.yCoord < object.yDest;
			} else if (object.xOrigin > object.xDest && object.yOrigin < object.yDest){
				return object.xCoord < object.xDest && object.yCoord > object.yDest;
			}
		}

		function acceptancePercent(accept){
			var value = Math.floor(Math.random() * 100) + 1;
			return value <= accept;
		};

		// TODO:
		function titleScreen(){
			back.font = "30px Arial";
			back.fillStyle = "white";
			back.fillText('Missile',10,100);
			back.fillText('Click anywhere to start',10,150);
		};

		// TODO:
		function scoreScreen(){
			clearScreen();
			back.font = "30px Arial";
			back.fillStyle = "white";
			back.fillText('GAME OVER',10,100);
			back.fillText('Click anywhere to restart',10,150);
		};

		//clearScreen
		function clearBackground(){
			back.clearRect(0,0,800,600);
		};

		function clearPlayground(){
			play.clearRect(0,0,800,600);
		};

		function clearAll(){
			clearBackground();
			clearPlayground();
		};

		function initialiseGame(){
			clearAll();
			terrainCreate();
			game.status = 'playing';
			p.removeEventListener('click', initialiseGame);
			p.addEventListener('click', spawnMissile)
			controller();
		};

		// Starts the game
		controller();
		function controller(){
			if (game.status === 'playing'){
				// Starts the game
				clearPlayground();
				enemySpawn();
				enemyMove();
				missileMove();
				//addTrails();
				rechargeTowers();
				// just add previous positions calculating on the fly with position - speed - gameSpeed
				//evaluateGame
				window.requestAnimationFrame(controller);
			} else if (game.status === 'over'){
				p.removeEventListener('click', spawnMissile);
				// Score screen
				scoreScreen();
				p.addEventListener('click', initialiseGame);
			} else {
				// Title screen
				titleScreen();
				p.addEventListener('click', initialiseGame);
			}
		};
	</script>
</html>
